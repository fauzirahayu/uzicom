@startuml Sequence Diagram Add Jamaah

title Sequence Diagram - Tambah Jamaah Haji

actor Admin
participant "Form Jamaah" as Form
participant "addJamaahWithPembimbing.php" as Process
participant "Database" as DB

Admin -> Form: Akses form tambah jamaah
Form -> Admin: Tampilkan form dengan pilihan pembimbing

Admin -> Form: Isi data (nama, NIK, no_porsi, pembimbing, dll) dan submit
Form -> Process: POST: id_pembimbing, nama_lengkap, nik, no_porsi, status, etc

Process -> Process: Validasi field harus terisi

alt Jika ada field kosong
    Process -> Admin: Alert "Semua field harus diisi!"
    Process -> Form: Redirect ke form
else Semua field terisi
    Process -> DB: SELECT COUNT(*) dari semua tabel jamaah WHERE id_pembimbing = ?
    DB --> Process: Return jumlah jamaah dibimbing pembimbing
    
    alt Jumlah jamaah >= 20
        Process -> Admin: Alert "Pembimbing sudah membimbing 20 jamaah"
        Process -> Form: Redirect ke form
    else Jumlah < 20
        Process -> DB: SELECT COUNT(*) FROM jamaah_haji
        DB --> Process: Return total jamaah haji
        
        alt Total jamaah_haji >= 50
            Process -> Admin: Alert "Jumlah jamaah haji sudah maksimal 50"
            Process -> Form: Redirect ke form
        else Total < 50
            Process -> Process: Cek status jamaah
            
            alt Status = 'belum lunas'
                Process -> Process: Set no_porsi = '-'
            else Status = 'lunas'
                alt no_porsi == NIK
                    Process -> Admin: Alert "No Porsi tidak boleh sama dengan NIK"
                    Process -> Form: Redirect ke form
                else no_porsi != NIK
                    Process -> DB: SELECT COUNT(*) FROM semua tabel WHERE no_porsi = ?
                    DB --> Process: Return count no_porsi
                    
                    alt no_porsi sudah ada
                        Process -> Admin: Alert "No Porsi sudah terdaftar"
                        Process -> Form: Redirect ke form
                    else no_porsi belum ada
                        Process -> Process: Hitung data_pulang (+40 hari dari jadwal_berangkat)
                        
                        alt Foto diupload
                            Process -> Process: Upload foto ke /uploads dengan nama timestamp
                        else Tidak ada foto
                            Process -> Process: Set foto = ''
                        end
                        
                        Process -> DB: INSERT INTO jamaah_haji (all data fields)
                        DB --> Process: Return insert result
                        
                        alt Insert berhasil
                            Process -> Admin: Alert "Jamaah berhasil ditambahkan"
                            Process -> Form: Redirect ke list jamaah
                        else Insert gagal
                            Process -> Admin: Alert "Error: Gagal menambahkan jamaah"
                        end
                    end
                end
            end
        end
    end
end

@enduml
