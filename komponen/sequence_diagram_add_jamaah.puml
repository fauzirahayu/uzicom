@startuml Sequence Diagram Add Jamaah

title Sequence Diagram Add Jamaah Sistem Manajemen Haji

actor Admin as Admin
participant "tampilantahun jamaah" as JamaahPage
participant "tampilan tambah jamaah" as FormPage
participant "proses add" as AddJamaah
participant "Database" as DB
participant "tampilan tahun jamaah" as JamaahList

Admin -> JamaahPage: Akses halaman jamaah
JamaahPage -> Admin: Tampilkan list jamaah dengan tombol tambah

Admin -> FormPage: Klik tombol tambah
FormPage -> Admin: Tampilkan form tambah jamaah

Admin -> FormPage: Isi form (nama, nik, no_porsi, dll) dan submit
FormPage -> AddJamaah: Kirim POST data (form data, foto)

AddJamaah -> DB: Query SELECT COUNT(*) FROM jamaah_haji WHERE id_pembimbing = ?
DB --> AddJamaah: Return jumlah jamaah pembimbing

alt Jumlah >= 20
    AddJamaah -> FormPage: Redirect dengan alert "Pembimbing sudah membimbing 20 jamaah"
else Jumlah < 20
    AddJamaah -> DB: Query SELECT COUNT(*) FROM jamaah_haji
    DB --> AddJamaah: Return total jamaah

    alt Total >= 50
        AddJamaah -> JamaahPage: Redirect dengan alert "Jumlah jamaah sudah maksimal 50"
    else Total < 50
        AddJamaah -> DB: Query SELECT COUNT(*) FROM jamaah_haji WHERE nik = ?
        DB --> AddJamaah: Return count NIK

        alt NIK sudah ada
            AddJamaah -> FormPage: Redirect dengan alert "NIK sudah terdaftar"
        else NIK belum ada
            AddJamaah -> DB: Query SELECT COUNT(*) FROM jamaah_haji WHERE no_porsi = ?
            DB --> AddJamaah: Return count no_porsi

            alt No Porsi sudah ada
                AddJamaah -> FormPage: Redirect dengan alert "No Porsi sudah terdaftar"
            else No Porsi belum ada
                alt No Porsi == NIK
                    AddJamaah -> FormPage: Redirect dengan alert "No Porsi tidak boleh sama dengan NIK"
                else No Porsi != NIK
                    AddJamaah -> AddJamaah: Hitung data_pulang (+40 hari dari jadwal_berangkat)

                    alt Foto diupload
                        AddJamaah -> AddJamaah: Upload foto ke /uploads
                    end

                    AddJamaah -> DB: INSERT INTO jamaah_haji (data fields)
                    DB --> AddJamaah: Return insert result

                    alt Insert berhasil
                        AddJamaah -> JamaahList: Redirect to tampilan tambah jamaah
                        JamaahList --> Admin: Tampilkan list jamaah
                    else Insert gagal
                        AddJamaah -> Admin: Tampilkan error message
                    end
                end
            end
        end
    end
end

@enduml
